import React, { useState, useEffect } from 'react';

const MatchingGame = () => {
  // Game state
  const [cards, setCards] = useState([]);
  const [flipped, setFlipped] = useState([]);
  const [solved, setSolved] = useState([]);
  const [moves, setMoves] = useState(0);
  const [gameOver, setGameOver] = useState(false);
  const [gameStarted, setGameStarted] = useState(false);
  const [difficulty, setDifficulty] = useState('easy'); // easy, medium, hard

  // Original data for the game
  const gameData = [
    { role: "Clinical/Senior Pharmacist", description: "Conducts structured medication reviews and provides prescribing/deprescribing services", imageUrl: "/api/placeholder/120/120" },
    { role: "Pharmacy Technician", description: "Manages prescriptions and conducts medicines reconciliation", imageUrl: "/api/placeholder/130/120" },
    { role: "Social Prescribing Link Worker", description: "Connects people to community-based activities, groups and services", imageUrl: "/api/placeholder/140/120" },
    { role: "Health and Wellbeing Coach", description: "Uses coaching skills to support people to make informed health choices", imageUrl: "/api/placeholder/120/130" },
    { role: "Care Co-ordinator", description: "Provides co-ordination and navigation through health and care systems", imageUrl: "/api/placeholder/130/130" },
    { role: "First Contact Physiotherapist", description: "Assesses, diagnoses, treats and manages musculoskeletal problems", imageUrl: "/api/placeholder/140/130" },
    { role: "Paramedic", description: "Performs home visits for urgent assessment and manages minor illness", imageUrl: "/api/placeholder/120/140" },
    { role: "Occupational Therapist", description: "Helps people find ways to continue with everyday activities", imageUrl: "/api/placeholder/130/140" },
    { role: "Podiatrist", description: "Diagnoses, treats and manages foot problems from various diseases", imageUrl: "/api/placeholder/140/140" },
    { role: "Dietitian", description: "Provides specialist advice for diabetes, weight management, and food allergies", imageUrl: "/api/placeholder/120/150" },
    { role: "Nursing Associate", description: "Enables registered nurses to provide care and maintains health records", imageUrl: "/api/placeholder/130/150" },
    { role: "Mental Health Practitioner", description: "Supports adults with complex mental health needs", imageUrl: "/api/placeholder/140/150" },
    { role: "Physician Associate", description: "Manages undiagnosed cases through examination and clinical decision-making", imageUrl: "/api/placeholder/120/160" },
    { role: "General Practice Assistant", description: "Arranges clinical support and provides administrative assistance", imageUrl: "/api/placeholder/130/160" },
    { role: "Digital Transformation Lead", description: "Undertakes improvement projects including adoption of digital tools", imageUrl: "/api/placeholder/140/160" },
    { role: "Advanced Practitioner", description: "Assesses patients and manages complex co-morbidities across specialties", imageUrl: "/api/placeholder/120/170" }
  ];

  // Initialize or reset the game
  const initializeGame = () => {
    let selectedRoles;
    
    // Select roles based on difficulty
    if (difficulty === 'easy') {
      selectedRoles = gameData.slice(0, 6);
    } else if (difficulty === 'medium') {
      selectedRoles = gameData.slice(0, 10);
    } else {
      selectedRoles = gameData;
    }
    
    // Create pairs (role and description)
    let cardPairs = [];
    selectedRoles.forEach(item => {
      cardPairs.push({ 
        id: `role-${item.role}`, 
        content: item.role, 
        type: 'role', 
        matchId: `desc-${item.role}`,
        imageUrl: item.imageUrl
      });
      cardPairs.push({ 
        id: `desc-${item.role}`, 
        content: item.description, 
        type: 'description', 
        matchId: `role-${item.role}` 
      });
    });
    
    // Shuffle cards
    cardPairs.sort(() => Math.random() - 0.5);
    
    setCards(cardPairs);
    setFlipped([]);
    setSolved([]);
    setMoves(0);
    setGameOver(false);
    setGameStarted(true);
  };
  
  // Handle card click
  const handleCardClick = (id) => {
    // Don't allow clicks if game over or card already flipped/solved
    if (gameOver || flipped.includes(id) || solved.includes(id) || flipped.length >= 2) {
      return;
    }
    
    // Flip the card
    const newFlipped = [...flipped, id];
    setFlipped(newFlipped);
    
    // If two cards are flipped, check for match
    if (newFlipped.length === 2) {
      setMoves(prevMoves => prevMoves + 1);
      
      const firstCard = cards.find(card => card.id === newFlipped[0]);
      const secondCard = cards.find(card => card.id === newFlipped[1]);
      
      // Check if cards match
      if (firstCard.matchId === secondCard.id) {
        setSolved(prevSolved => [...prevSolved, firstCard.id, secondCard.id]);
        setFlipped([]);
      } else {
        // If not a match, flip back after delay
        setTimeout(() => {
          setFlipped([]);
        }, 1500);
      }
    }
  };
  
  // Check for game over
  useEffect(() => {
    if (solved.length === cards.length && cards.length > 0) {
      setGameOver(true);
      setGameStarted(false);
    }
  }, [solved, cards]);
  
  // Initialize the game with default settings if gameData is loaded
  useEffect(() => {
    if (gameData.length > 0 && !gameStarted && !gameOver) {
      // Auto-start with 'easy' difficulty
      setDifficulty('easy');
      initializeGame();
    }
  }, []);

  return (
    <div className="flex flex-col items-center p-4 max-w-4xl mx-auto">
      <h1 className="text-3xl font-bold mb-6 text-center">Healthcare Roles Matching Game</h1>
      
      <div className="flex justify-between w-full mb-4">
        <div className="text-lg font-medium">Moves: {moves}</div>
        
        <div className="flex space-x-2">
          <button
            onClick={() => {
              setDifficulty('easy');
              initializeGame();
            }}
            className={`px-3 py-1 rounded ${difficulty === 'easy' ? 'bg-[#00999E] text-white' : 'bg-gray-200'}`}
          >
            Easy
          </button>
          <button
            onClick={() => {
              setDifficulty('medium');
              initializeGame();
            }}
            className={`px-3 py-1 rounded ${difficulty === 'medium' ? 'bg-[#00999E] text-white' : 'bg-gray-200'}`}
          >
            Medium
          </button>
          <button
            onClick={() => {
              setDifficulty('hard');
              initializeGame();
            }}
            className={`px-3 py-1 rounded ${difficulty === 'hard' ? 'bg-[#00999E] text-white' : 'bg-gray-200'}`}
          >
            Hard
          </button>
        </div>
      </div>
      
      {gameOver ? (
        <div className="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4 w-full text-center">
          <p className="font-bold">Congratulations!</p>
          <p>You completed the game in {moves} moves.</p>
          <button
            onClick={() => {
              initializeGame();
            }}
            className="mt-4 bg-[#00999E] hover:bg-teal-700 text-white font-bold py-2 px-4 rounded"
          >
            Play Again
          </button>
        </div>
      ) : (
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 w-full">
          {cards.map((card) => (
            <div
              key={card.id}
              onClick={() => handleCardClick(card.id)}
              className={`
                h-40 md:h-40 
                rounded-lg shadow-md 
                flex flex-col items-center justify-center 
                cursor-pointer
                transition-all duration-300
                p-2
                ${flipped.includes(card.id) || solved.includes(card.id) 
                  ? 'bg-white border-2' 
                  : 'bg-[#00999E] text-white'}
                ${solved.includes(card.id) ? 'border-green-500' : ''}
                ${card.type === 'role' ? 'font-bold' : ''}
              `}
            >
              {(flipped.includes(card.id) || solved.includes(card.id)) ? (
                <>
                  {card.type === 'role' && (
                    <div className="mb-2">
                      <img 
                        src={card.imageUrl} 
                        alt={card.content} 
                        className="w-16 h-16 rounded-full object-cover mb-1"
                      />
                    </div>
                  )}
                  <div className="text-center text-sm md:text-base text-gray-800">
                    {card.content}
                  </div>
                </>
              ) : (
                <div className="text-4xl">?</div>
              )}
            </div>
          ))}
        </div>
      )}
    </div>
  );
};

export default MatchingGame;
